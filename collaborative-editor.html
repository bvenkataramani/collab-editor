<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Collaborative Text Editor</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    cursor: text;
    user-select: none;
  }
  #editor {
    position: relative;
    width: 100%;
    height: 100%;
  }
  .textbox {
    position: absolute;
    min-width: 100px;
    min-height: 20px;
    outline: none;
    font-size: 16px;
    line-height: 1.5;
  }
  .textbox:focus {
    border: 1px solid #aaa;
  }
</style>
</head>
<body>
<div id="editor"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Your web app's Firebase configuration
  // You need to add your own API info here!
};

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const editor = document.getElementById('editor');
  const docId = getDocumentId();

  // Map to store textbox elements by their IDs
  const textboxesMap = {};

  // Listen for changes in the Firestore document
  db.collection('documents').doc(docId).onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      renderTextboxes(data.textboxes || []);
    }
  });

  // Function to get or generate a document ID from the URL
  function getDocumentId() {
    const params = new URLSearchParams(window.location.search);
    let id = params.get('doc');
    if (!id) {
      id = generateId();
      params.set('doc', id);
      window.history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
    }
    return id;
  }

  // Generate a random ID
  function generateId() {
    return Math.random().toString(36).substring(2, 10);
  }

  // Function to render textboxes
  function renderTextboxes(textboxesData) {
    const existingIds = new Set();

    textboxesData.forEach((data) => {
      existingIds.add(data.id);

      let textbox = textboxesMap[data.id];

      if (textbox) {
        // Update existing textbox
        if (document.activeElement !== textbox) {
          textbox.innerHTML = data.content;
        }
        textbox.style.left = data.left;
        textbox.style.top = data.top;
      } else {
        // Create new textbox
        textbox = document.createElement('div');
        textbox.contentEditable = true;
        textbox.className = 'textbox';
        textbox.style.left = data.left;
        textbox.style.top = data.top;
        textbox.innerHTML = data.content;
        textbox.dataset.id = data.id;

        // Event listeners
        textbox.addEventListener('input', syncData);
        textbox.addEventListener('blur', syncData);

        editor.appendChild(textbox);
        textboxesMap[data.id] = textbox;
      }
    });

    // Remove any textboxes that are no longer in Firestore data
    for (const id in textboxesMap) {
      if (!existingIds.has(id)) {
        const textbox = textboxesMap[id];
        editor.removeChild(textbox);
        delete textboxesMap[id];
      }
    }
  }

  // Sync data to Firestore
  function syncData() {
    const textboxes = Object.values(textboxesMap).map((textbox) => ({
      id: textbox.dataset.id,
      left: textbox.style.left,
      top: textbox.style.top,
      content: textbox.innerHTML,
    }));

    db.collection('documents').doc(docId).set({ textboxes });
  }

  editor.addEventListener('dblclick', function(e) {
    // Prevent the default text selection
    e.preventDefault();

    // Get the click position
    const x = e.clientX + window.scrollX;
    const y = e.clientY + window.scrollY;

    // Create a new editable div at the click position
    const textbox = document.createElement('div');
    textbox.contentEditable = true;
    textbox.className = 'textbox';
    textbox.style.left = x + 'px';
    textbox.style.top = y + 'px';
    const id = generateId();
    textbox.dataset.id = id;

    // Event listeners
    textbox.addEventListener('input', syncData);
    textbox.addEventListener('blur', syncData);

    // Append the textbox to the editor
    editor.appendChild(textbox);

    // Add to the textboxes map
    textboxesMap[id] = textbox;

    // Focus on the new textbox
    textbox.focus();

    // Sync data
    syncData();
  });

  // Remove empty textboxes when they lose focus
  editor.addEventListener('focusout', function(e) {
    const textbox = e.target;
    if (textbox.classList.contains('textbox') && textbox.textContent.trim() === '') {
      editor.removeChild(textbox);
      delete textboxesMap[textbox.dataset.id];
      syncData();
    }
  });
</script>
</body>
</html>
